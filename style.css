document.addEventListener("DOMContentLoaded", function () {
    const cake = document.querySelector(".cake");
    const candleCountDisplay = document.getElementById("candleCount");
    const startOverlay = document.getElementById("startOverlay");
    const startButton = document.getElementById("startButton");
    
    let candles = [];
    let audioContext;
    let analyser;
    let microphone;
    let celebrationStarted = false;

    // Matches your Vercel filename exactly
    let audio = new Audio('HappyBirthdaySong.mp3'); 

    // 1. CLICK TO START (Unlocks audio for mobile/Vercel)
    startButton.addEventListener("click", function() {
        // Unlock audio track for browsers
        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
        }).catch(e => console.log("Audio waiting for user gesture"));

        // Hide overlay
        startOverlay.style.opacity = "0";
        setTimeout(() => startOverlay.style.display = "none", 500);

        // Start Microphone process
        initMicrophone();
    });

    function updateCandleCount() {
        const activeCandles = candles.filter(c => !c.classList.contains("out")).length;
        candleCountDisplay.textContent = activeCandles;
    }

    function addCandle(left, top) {
        const candle = document.createElement("div");
        candle.className = "candle";
        candle.style.left = left + "px";
        candle.style.top = top + "px";
        const flame = document.createElement("div");
        flame.className = "flame";
        candle.appendChild(flame);
        cake.appendChild(candle);
        candles.push(candle);
        updateCandleCount();
    }

    cake.addEventListener("click", (event) => {
        const rect = cake.getBoundingClientRect();
        addCandle(event.clientX - rect.left, event.clientY - rect.top);
    });

    function isBlowing() {
        if (!analyser) return false;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        let sum = dataArray.reduce((a, b) => a + b, 0);
        let average = sum / dataArray.length;
        return average > 50; 
    }

    function blowOutCandles() {
        if (candles.length === 0 || celebrationStarted) return;

        if (isBlowing()) {
            candles.forEach((candle) => {
                if (!candle.classList.contains("out") && Math.random() > 0.4) {
                    candle.classList.add("out");
                }
            });
            updateCandleCount();
        }

        // Trigger celebration only when all candles are out
        if (candles.length > 0 && candles.every(c => c.classList.contains("out"))) {
            celebrationStarted = true;
            playCelebration();
        }
    }

    function playCelebration() {
        audio.play().catch(e => console.log("Final playback failed: " + e));
        
        confetti({
            particleCount: 150, spread: 100, origin: { y: 0.6 },
            colors: ['#ff6999', '#ff8fab', '#fb6f92']
        });

        const duration = 15 * 1000;
        const animationEnd = Date.now() + duration;
        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            confetti({ 
                particleCount: 40, 
                origin: { x: Math.random(), y: Math.random() - 0.2 },
                colors: ['#ffc2d1', '#ff8fab', '#fb6f92']
            });
        }, 250);
    }

    function initMicrophone() {
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    analyser.fftSize = 256;
                    setInterval(blowOutCandles, 200);
                })
                .catch(err => console.log("Mic access error: " + err));
        }
    }
});
